# üê≥ DGSUC Docker Infrastructure

Infraestructura Docker containerizada para el Sistema de Informes y Controles DGSUC.

> **Nota**: Este repositorio contiene √∫nicamente la infraestructura Docker. El c√≥digo de la aplicaci√≥n se clona desde un repositorio separado.

## üèóÔ∏è Arquitectura

```
dgsuc-docker/                 # Este repositorio
‚îú‚îÄ‚îÄ docker/                   # Configuraciones Docker
‚îÇ   ‚îú‚îÄ‚îÄ app/                 # PHP-FPM
‚îÇ   ‚îú‚îÄ‚îÄ nginx/               # Servidor web
‚îÇ   ‚îú‚îÄ‚îÄ workers/             # Queue workers
‚îÇ   ‚îú‚îÄ‚îÄ postgres/            # Base de datos
‚îÇ   ‚îú‚îÄ‚îÄ redis/               # Cache y sesiones
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/          # Prometheus + Grafana
‚îú‚îÄ‚îÄ scripts/                  # Scripts de gesti√≥n
‚îú‚îÄ‚îÄ app/                      # ‚Üê Aplicaci√≥n Laravel (clonada aqu√≠)
‚îî‚îÄ‚îÄ docker-compose.yml        # Orquestaci√≥n
```

## üöÄ Quick Start

### 1Ô∏è‚É£ Clonar este repositorio

```bash
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker
```

### 2Ô∏è‚É£ Inicializaci√≥n autom√°tica

```bash
make init
```

Este comando realizar√°:
- ‚úÖ Verificaci√≥n de prerequisitos
- ‚úÖ Clonado de la aplicaci√≥n Laravel
- ‚úÖ Configuraci√≥n de variables de entorno
- ‚úÖ Build de im√°genes Docker
- ‚úÖ Inicializaci√≥n de base de datos

### 3Ô∏è‚É£ Iniciar servicios

```bash
# Desarrollo
make dev

# Producci√≥n
make prod
```

## üìã Requisitos Previos

### Software
- Docker >= 20.10
- Docker Compose >= 2.0
- Git >= 2.30
- Make (opcional pero recomendado)

### Hardware M√≠nimo
- CPU: 4 cores
- RAM: 8 GB
- Disco: 100 GB SSD

## üîß Instalaci√≥n Manual Detallada

### Paso 1: Preparar el entorno

```bash
# Clonar infraestructura
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker

# Clonar aplicaci√≥n
./scripts/clone-app.sh [URL_REPOSITORIO] [BRANCH]
# O usar valores por defecto:
./scripts/clone-app.sh
```

### Paso 2: Configurar variables de entorno

```bash
# Copiar plantillas
cp .env.example .env.dev
cp .env.example .env.prod

# Editar seg√∫n necesidad
nano .env.prod
```

Variables cr√≠ticas a configurar:

```env
# Base de datos principal
DB_DATABASE=informes_app
DB_USERNAME=informes_user
DB_PASSWORD=contrase√±a_segura

# Redis Cache
REDIS_PASSWORD=redis_contrase√±a_segura

# Azure AD (SSO)
MICROSOFT_CLIENT_ID=xxx
MICROSOFT_CLIENT_SECRET=xxx
MICROSOFT_REDIRECT_URI=https://dgsuc.uba.ar/auth/microsoft/callback

# SSL Certificates
CERTBOT_EMAIL=admin@uba.ar
CERTBOT_DOMAIN=dgsuc.uba.ar

# Monitoring
GRAFANA_PASSWORD=grafana_admin_password
```

### Paso 3: Configurar aplicaci√≥n Laravel

```bash
# Clonar y configurar aplicaci√≥n
make clone

# Configurar permisos
chmod -R 775 ./app/storage
chmod -R 775 ./app/bootstrap/cache
```

### Paso 4: SSL/TLS

```bash
# Opci√≥n 1: Let's Encrypt (producci√≥n)
./scripts/ssl-setup.sh letsencrypt dgsuc.uba.ar admin@uba.ar

# Opci√≥n 2: Certificado existente
./scripts/ssl-setup.sh import /path/to/cert.pem /path/to/key.pem

# Opci√≥n 3: Auto-firmado (desarrollo)
./scripts/ssl-setup.sh self-signed
```

### Paso 5: Build y deploy

```bash
# Build de im√°genes
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

# Iniciar servicios
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Verificar estado
docker-compose ps
```

## üì¶ Servicios Incluidos

| Servicio | Puerto | Descripci√≥n |
|----------|--------|-------------|
| **app** | 9000 | PHP-FPM 8.3 con Laravel |
| **nginx** | 80/443 | Servidor web con SSL |
| **postgres** | 5432 | PostgreSQL 17 |
| **redis** | 6379 | Cache y sesiones |
| **workers** | - | Queue workers (Supervisor) |
| **scheduler** | - | Laravel scheduler (cron) |
| **certbot** | - | Certificados SSL autom√°ticos |
| **prometheus** | 9090 | M√©tricas (producci√≥n) |
| **grafana** | 3000 | Dashboards (producci√≥n) |

### Servicios de Desarrollo

| Servicio | Puerto | URL |
|----------|--------|-----|
| **app** | 8080 | http://localhost:8080 |
| **mailhog** | 8025 | http://localhost:8025 |
| **phpmyadmin** | 8090 | http://localhost:8090 |
| **xdebug** | 9003 | - |
| **node** | - | Compilaci√≥n de assets |

## üéÆ Comandos Principales

### Gesti√≥n de Servicios

```bash
make dev              # Iniciar desarrollo
make prod             # Iniciar producci√≥n
make stop             # Detener servicios
make restart          # Reiniciar servicios
make ps               # Ver estado
make logs             # Ver logs
```

### Aplicaci√≥n

```bash
make clone            # Clonar aplicaci√≥n
make update           # Actualizar c√≥digo
make shell            # Entrar al contenedor
make artisan cmd="..." # Ejecutar comando Artisan
make composer cmd="..." # Ejecutar Composer
make npm cmd="..."    # Ejecutar NPM
```

### Base de Datos

```bash
make db-migrate       # Ejecutar migraciones
make db-seed          # Ejecutar seeders
make db-fresh         # Fresh con seeds
make db-backup        # Crear backup
make db-restore       # Restaurar backup
```

### Cache y Optimizaci√≥n

```bash
make cache-clear      # Limpiar todos los caches
make cache-build      # Construir caches (producci√≥n)
```

### Queue Workers

```bash
make queue-work       # Iniciar worker manual
make queue-restart    # Reiniciar workers
make queue-failed     # Ver jobs fallidos
make queue-retry      # Reintentar jobs fallidos
```

### SSL/TLS

```bash
make ssl-generate     # Generar con Let's Encrypt
make ssl-renew        # Renovar certificados
make ssl-staging      # Generar certificados de prueba
```

## üîÑ Workflow de Desarrollo

### 1. Primera vez

```bash
# Clonar infraestructura
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker

# Inicializar
make init

# Seleccionar "Development" cuando se pregunte
# Configurar .env.dev si es necesario

# Iniciar servicios
make dev

# Aplicaci√≥n disponible en http://localhost:8080
```

### 2. Desarrollo diario

```bash
# Iniciar ambiente
make dev

# Ver logs
make logs

# Ejecutar migraciones
make db-migrate

# Entrar al contenedor
make shell

# Detener al finalizar
make stop
```

### 3. Actualizar aplicaci√≥n

```bash
# Pull √∫ltimos cambios
make update

# Reinstalar dependencias si es necesario
make composer cmd="install"

# Ejecutar migraciones
make db-migrate

# Reiniciar servicios
make restart
```

## üöÄ Deployment a Producci√≥n

### 1. Preparaci√≥n

```bash
# Configurar variables de producci√≥n
cp .env.example .env.prod
nano .env.prod

# Configurar SSL
./scripts/ssl-setup.sh letsencrypt dgsuc.uba.ar admin@uba.ar

# Configurar variables de entorno de producci√≥n
cp .env.example .env.prod
# Editar variables sensibles como REDIS_PASSWORD, MICROSOFT_CLIENT_SECRET, etc.
```

### 2. Deploy

```bash
# Build de producci√≥n
BUILD_TARGET=production make prod-build

# Deploy
make prod

# Verificar
make health
```

### 3. Post-deployment

```bash
# Verificar servicios
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# Verificar logs
make prod-logs

# Test de conectividad
curl -k https://localhost/health
```

## üìä Configuraci√≥n de Redis y Cache

Redis se utiliza para cache, sesiones y colas de trabajo:

### Configuraci√≥n b√°sica

```env
# .env.prod
REDIS_PASSWORD=password_segura
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
```

### Configuraci√≥n avanzada

```env
# Configuraci√≥n de memoria
REDIS_MAXMEMORY=2gb
REDIS_MAXMEMORY_POLICY=allkeys-lru

# Persistencia
REDIS_SAVE=900 1 300 10 60 10000
REDIS_APPENDONLY=yes
```

### Monitoreo de Redis

```bash
# Verificar estado de Redis
docker-compose exec redis redis-cli ping

# Ver logs
docker-compose logs redis

# Monitorear conexiones
docker-compose exec redis redis-cli monitor
```

## üêõ Troubleshooting

### Problema: "Application not found"

```bash
# Clonar aplicaci√≥n
make clone

# O manualmente
./scripts/clone-app.sh https://github.com/cristianfloyd/informes-app.git
```

### Problema: "Connection refused" a Redis

```bash
# Verificar estado de Redis
docker-compose ps redis

# Reiniciar Redis
docker-compose restart redis

# Verificar conectividad
docker-compose exec app php artisan cache:clear
```

### Problema: "Memory exhausted" en SICOSS

```bash
# Editar docker-compose.prod.yml
# Aumentar l√≠mites de memoria para workers:
deploy:
  resources:
    limits:
      memory: 8G
```

### Problema: Permisos en storage

```bash
# Desde el host
sudo chown -R 1000:1000 ./app/storage
chmod -R 775 ./app/storage

# O desde el contenedor
make shell
chown -R informes:informes storage
chmod -R 775 storage
```

## üìä Monitoreo

### Prometheus + Grafana (Producci√≥n)

```bash
# Iniciar monitoreo
make monitor-start

# Acceder a Grafana
# http://localhost:3000
# Usuario: admin
# Password: (configurada en .env.prod)
```

### M√©tricas disponibles

- CPU y memoria por contenedor
- Requests por segundo (Nginx)
- Queries lentas (PostgreSQL)
- Cache hit rate (Redis)
- Queue jobs procesados
- Certificados SSL y expiraci√≥n

## üîí Seguridad

### Checklist de Producci√≥n

- [ ] Cambiar todas las contrase√±as por defecto
- [ ] Configurar SSL/TLS v√°lido
- [ ] Limitar acceso a puertos (firewall)
- [ ] Configurar backup autom√°tico
- [ ] Habilitar logs de auditor√≠a
- [ ] Configurar monitoreo
- [ ] Revisar permisos de archivos
- [ ] Actualizar im√°genes regularmente

### Hardening

```bash
# Escanear vulnerabilidades
docker scan dgsuc_app:latest

# Limitar recursos
docker update --memory="4g" --cpus="2" dgsuc_app

# Auditor√≠a con Trivy
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image dgsuc_app:latest
```

## üìÅ Estructura de Directorios

```
dgsuc-docker/
‚îú‚îÄ‚îÄ docker/                    # Configuraciones Docker
‚îÇ   ‚îú‚îÄ‚îÄ app/                  # PHP-FPM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.dev
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php.ini
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php-dev.ini
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh
‚îÇ   ‚îú‚îÄ‚îÄ nginx/                # Nginx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sites/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ workers/              # Queue workers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supervisord.conf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh
‚îÇ   ‚îú‚îÄ‚îÄ postgres/             # PostgreSQL
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ postgresql.conf
‚îÇ   ‚îú‚îÄ‚îÄ redis/                # Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis.conf
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/           # Prometheus + Grafana
‚îÇ       ‚îú‚îÄ‚îÄ prometheus/
‚îÇ       ‚îî‚îÄ‚îÄ grafana/
‚îú‚îÄ‚îÄ scripts/                   # Scripts de gesti√≥n
‚îÇ   ‚îú‚îÄ‚îÄ init.sh              # Inicializaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ clone-app.sh         # Clonar aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh            # Deployment
‚îÇ   ‚îú‚îÄ‚îÄ backup.sh            # Backups
‚îÇ   ‚îî‚îÄ‚îÄ ssl-setup.sh         # Configurar SSL
‚îú‚îÄ‚îÄ app/                      # Aplicaci√≥n (ignorado en git)
‚îú‚îÄ‚îÄ docker-compose.yml        # Configuraci√≥n base
‚îú‚îÄ‚îÄ docker-compose.dev.yml    # Override desarrollo
‚îú‚îÄ‚îÄ docker-compose.prod.yml   # Override producci√≥n
‚îú‚îÄ‚îÄ .env.example             # Plantilla de variables
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ Makefile                 # Comandos simplificados
‚îî‚îÄ‚îÄ README.md                # Este archivo
```

## üîÑ Actualizaci√≥n de la Infraestructura

```bash
# Pull √∫ltimos cambios de infraestructura
git pull origin main

# Rebuild im√°genes
make prod-build

# Restart servicios
make prod-restart
```

## üìù Variables de Entorno Importantes

| Variable | Descripci√≥n | Ejemplo |
|----------|-------------|---------|
| `APP_ENV` | Entorno de aplicaci√≥n | production |
| `APP_URL` | URL de la aplicaci√≥n | https://dgsuc.uba.ar |
| `DB_PASSWORD` | Contrase√±a PostgreSQL | SecurePass123! |
| `REDIS_PASSWORD` | Contrase√±a Redis | RedisPass456! |
| `MICROSOFT_CLIENT_ID` | Azure AD Client ID | xxx-xxx-xxx |
| `CERTBOT_EMAIL` | Email para certificados SSL | admin@uba.ar |
| `CERTBOT_DOMAIN` | Dominio principal | dgsuc.uba.ar |
| `WORKER_MEMORY` | Memoria para workers | 4096 |
| `GRAFANA_PASSWORD` | Contrase√±a Grafana | GrafanaPass789! |

## ü§ù Contribuir

1. Fork del repositorio
2. Crear rama feature (`git checkout -b feature/AmazingFeature`)
3. Commit cambios (`git commit -m 'Add AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abrir Pull Request

## üìö Documentaci√≥n Adicional

- [Gu√≠a de Deployment Detallada](./docs/deployment.md)
- [Configuraci√≥n Avanzada](./docs/advanced.md)
- [Troubleshooting Completo](./docs/troubleshooting.md)
- [Arquitectura del Sistema](./docs/architecture.md)

## üìû Soporte

- **Email**: carenas@uba.ar
- **Issues**: https://github.com/cristianfloyd/dgsuc-docker/issues
- **Wiki**: https://github.com/cristianfloyd/dgsuc-docker/wiki

## üìÑ Licencia

Propiedad de la Universidad de Buenos Aires - Todos los derechos reservados.

---

**Versi√≥n**: 2.0.0  
**√öltima actualizaci√≥n**: Diciembre 2024  
**Mantenido por**: Equipo DGSUC - UBA