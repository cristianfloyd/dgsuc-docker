# üê≥ DGSUC Docker Infrastructure

Infraestructura Docker containerizada para el Sistema de Informes y Controles DGSUC.

> **Nota**: Este repositorio contiene √∫nicamente la infraestructura Docker. El c√≥digo de la aplicaci√≥n se clona desde un repositorio separado.

## üèóÔ∏è Arquitectura

```
dgsuc-docker/                 # Este repositorio
‚îú‚îÄ‚îÄ docker/                   # Configuraciones Docker
‚îÇ   ‚îú‚îÄ‚îÄ app/                 # PHP-FPM
‚îÇ   ‚îú‚îÄ‚îÄ nginx/               # Servidor web
‚îÇ   ‚îú‚îÄ‚îÄ workers/             # Queue workers
‚îÇ   ‚îú‚îÄ‚îÄ postgres/            # Base de datos
‚îÇ   ‚îú‚îÄ‚îÄ redis/               # Cache y sesiones
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/          # Prometheus + Grafana
‚îú‚îÄ‚îÄ scripts/                  # Scripts de gesti√≥n
‚îú‚îÄ‚îÄ app/                      # ‚Üê Aplicaci√≥n Laravel (clonada aqu√≠)
‚îî‚îÄ‚îÄ docker-compose.yml        # Orquestaci√≥n
```

## üöÄ Quick Start

### 1Ô∏è‚É£ Clonar este repositorio

```bash
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker
```

### 2Ô∏è‚É£ Inicializaci√≥n autom√°tica

```bash
make init
```

Este comando realizar√°:
- ‚úÖ Verificaci√≥n de prerequisitos
- ‚úÖ Clonado de la aplicaci√≥n Laravel
- ‚úÖ Configuraci√≥n de variables de entorno
- ‚úÖ Sincronizaci√≥n autom√°tica de credenciales DB
- ‚úÖ Build de im√°genes Docker
- ‚úÖ Inicializaci√≥n de base de datos con credenciales del .env

### 3Ô∏è‚É£ Iniciar servicios

```bash
# Desarrollo
make dev

# Producci√≥n
make prod
```

## üìã Requisitos Previos

### Software
- Docker >= 20.10
- Docker Compose >= 2.0
- Git >= 2.30
- Make (opcional pero recomendado)

### Hardware M√≠nimo
- CPU: 4 cores
- RAM: 8 GB
- Disco: 100 GB SSD

## üîß Instalaci√≥n Manual Detallada

### Paso 1: Preparar el entorno

```bash
# Clonar infraestructura
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker

# Clonar aplicaci√≥n
./scripts/clone-app.sh [URL_REPOSITORIO] [BRANCH]
# O usar valores por defecto:
./scripts/clone-app.sh
```

### Paso 2: Configurar variables de entorno

```bash
# Copiar plantillas
cp .env.example .env.dev
cp .env.example .env.prod

# Editar seg√∫n necesidad
nano .env.prod
```

Variables cr√≠ticas a configurar:

```env
# Base de datos principal (se sincroniza autom√°ticamente con Laravel)
DB_DATABASE=dgsuc_app
DB_USERNAME=dgsuc_user
DB_PASSWORD=contrase√±a_segura

# Redis Cache
REDIS_PASSWORD=redis_contrase√±a_segura

# Azure AD (SSO)
MICROSOFT_CLIENT_ID=xxx
MICROSOFT_CLIENT_SECRET=xxx
MICROSOFT_REDIRECT_URI=https://dgsuc.uba.ar/auth/microsoft/callback

# SSL Certificates
CERTBOT_EMAIL=admin@uba.ar
CERTBOT_DOMAIN=dgsuc.uba.ar

# Monitoring
GRAFANA_PASSWORD=grafana_admin_password
```

> **‚ö†Ô∏è Importante**: Las credenciales de base de datos se sincronizan autom√°ticamente entre el `.env` del directorio ra√≠z y `app/.env` durante la inicializaci√≥n. PostgreSQL utilizar√° estas credenciales para crear los usuarios correspondientes.

### Paso 3: Configurar aplicaci√≥n Laravel

```bash
# Clonar y configurar aplicaci√≥n
make clone

# El archivo .env se copia autom√°ticamente durante make init
# Si necesitas sincronizar manualmente:
cp .env ./app/.env

# Configurar permisos (autom√°tico en contenedores)
make fix-permissions          # O usar comandos tradicionales:
chmod -R 775 ./app/storage
chmod -R 775 ./app/bootstrap/cache
```

> **üìù Nota**: El proceso de inicializaci√≥n ahora copia autom√°ticamente el `.env` del directorio ra√≠z a `app/.env` y verifica que las credenciales de base de datos est√©n sincronizadas. Los permisos se gestionan con `dgsuc_user:www-data`.

### Paso 4: SSL/TLS

```bash
# Opci√≥n 1: Let's Encrypt (producci√≥n)
./scripts/ssl-setup.sh letsencrypt dgsuc.uba.ar admin@uba.ar

# Opci√≥n 2: Certificado existente
./scripts/ssl-setup.sh import /path/to/cert.pem /path/to/key.pem

# Opci√≥n 3: Auto-firmado (desarrollo)
./scripts/ssl-setup.sh self-signed
```

### Paso 5: Build y deploy

```bash
# Build de im√°genes
docker-compose -f docker-compose.yml -f docker-compose.prod.yml build

# Iniciar servicios
docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# Verificar estado
docker-compose ps
```

## üì¶ Servicios Incluidos

| Servicio | Puerto | Descripci√≥n |
|----------|--------|-------------|
| **app** | 9000 | PHP-FPM 8.3 con Laravel (dgsuc_user:www-data) |
| **nginx** | 80/443 | Servidor web con SSL |
| **postgres** | 5432 | PostgreSQL 17 |
| **redis** | 6379 | Cache y sesiones |
| **workers** | - | Queue workers (Supervisor) |
| **scheduler** | - | Laravel scheduler (cron) |
| **certbot** | - | Certificados SSL autom√°ticos |
| **prometheus** | 9090 | M√©tricas (producci√≥n) |
| **grafana** | 3000 | Dashboards (producci√≥n) |

### Servicios de Desarrollo

| Servicio | Puerto | URL |
|----------|--------|-----|
| **app** | 8080 | http://localhost:8080 |
| **mailhog** | 8025 | http://localhost:8025 |
| **phpmyadmin** | 8090 | http://localhost:8090 |
| **xdebug** | 9003 | - |
| **node** | - | Compilaci√≥n de assets |

## üéÆ Comandos Principales

### Gesti√≥n de Servicios

```bash
# Desarrollo
make dev              # Iniciar desarrollo b√°sico
make dev-deploy       # Deployment completo con assets
make dev-build-assets # Solo compilar assets

# Producci√≥n
make prod             # Iniciar producci√≥n b√°sico
make prod-deploy      # Deployment completo con assets
make prod-build-assets # Solo compilar assets

# General
make stop             # Detener servicios
make restart          # Reiniciar servicios
make ps               # Ver estado
make logs             # Ver logs
```

### Aplicaci√≥n

```bash
make clone            # Clonar aplicaci√≥n
make update           # Actualizar c√≥digo
make shell            # Entrar al contenedor
make artisan cmd="..." # Ejecutar comando Artisan
make composer cmd="..." # Ejecutar Composer
make npm cmd="..."    # Ejecutar NPM
```

### Assets y Frontend

```bash
# Desarrollo
make assets-build     # Compilar assets para desarrollo
make assets-watch     # Modo desarrollo con hot reload
make assets-install   # Instalar dependencias npm
make assets-check     # Verificar assets compilados
make assets-clean     # Limpiar assets compilados

# Producci√≥n
make prod-build-assets # Compilar assets para producci√≥n

# Comandos espec√≠ficos
make node-dev         # Vite en modo desarrollo
make node-build       # Compilar con servicio node
make node-install     # Instalar dependencias
```

### Base de Datos

```bash
make db-migrate       # Ejecutar migraciones
make db-seed          # Ejecutar seeders
make db-fresh         # Fresh con seeds
make db-backup        # Crear backup
make db-restore       # Restaurar backup
```

### Gesti√≥n de Permisos

```bash
# Verificar permisos actuales
make check-permissions            # Desarrollo
make prod-check-permissions       # Producci√≥n

# Corregir permisos autom√°ticamente
make fix-permissions              # Manual (dgsuc_user:www-data)
make fix-permissions-script       # Script integrado del contenedor
make prod-fix-permissions         # Producci√≥n

# Probar directorios escribibles
make check-writable

# Corregir desde host (√∫ltimo recurso)
make host-fix-permissions
```

### Cache y Optimizaci√≥n

```bash
make cache-clear      # Limpiar todos los caches
make cache-build      # Construir caches (producci√≥n)
```

### Queue Workers

```bash
make queue-work       # Iniciar worker manual
make queue-restart    # Reiniciar workers
make queue-failed     # Ver jobs fallidos
make queue-retry      # Reintentar jobs fallidos
```

### SSL/TLS

```bash
make ssl-generate     # Generar con Let's Encrypt
make ssl-renew        # Renovar certificados
make ssl-staging      # Generar certificados de prueba
```

## üîÑ Workflow de Desarrollo

### 1. Primera vez

```bash
# Clonar infraestructura
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker

# Inicializar
make init

# Seleccionar "Development" cuando se pregunte
# Configurar .env.dev si es necesario

# Iniciar servicios
make dev

# Aplicaci√≥n disponible en http://localhost:8080
```

#### Para Windows:

```bash
# Clonar infraestructura
git clone https://github.com/cristianfloyd/dgsuc-docker.git
cd dgsuc-docker

# Inicializar
make init

# Iniciar servicios (Windows optimizado)
make dev-windows

# En otra terminal, para hot reload de assets:
make node-dev

# Aplicaci√≥n disponible en http://localhost:8080
```

#### Si hay problemas de build:

```bash
# Limpiar y reconstruir completamente
make dev-rebuild

# O limpiar manualmente
make dev-clean
make dev
```

### 2. Desarrollo diario

#### Linux/macOS:
```bash
# Iniciar ambiente
make dev

# Ver logs
make logs

# Ejecutar migraciones
make db-migrate

# Entrar al contenedor
make shell

# Detener al finalizar
make stop
```

#### Windows:
```bash
# Iniciar ambiente (Windows optimizado)
make dev-windows

# En otra terminal, para hot reload de assets:
make node-dev

# Ver logs
make logs

# Ejecutar migraciones
make db-migrate

# Entrar al contenedor
make shell

# Detener al finalizar
make stop
```

### 3. Actualizar aplicaci√≥n

```bash
# Pull √∫ltimos cambios
make update

# Reinstalar dependencias si es necesario
make composer cmd="install"

# Compilar assets (si hay cambios en frontend)
make assets-build

# Ejecutar migraciones
make db-migrate

# Reiniciar servicios
make restart
```

### 4. Trabajo con assets

```bash
# Desarrollo con hot reload
make assets-watch

# Compilar para producci√≥n
make assets-build

# Verificar assets compilados
make assets-check

# Limpiar y recompilar
make assets-clean
make assets-build
```

## üöÄ Deployment a Producci√≥n

### 1. Preparaci√≥n

```bash
# Configurar variables de producci√≥n
cp .env.example .env.prod
nano .env.prod

# Configurar SSL
./scripts/ssl-setup.sh letsencrypt dgsuc.uba.ar admin@uba.ar

# Configurar variables de entorno de producci√≥n
cp .env.example .env.prod
# Editar variables sensibles como REDIS_PASSWORD, MICROSOFT_CLIENT_SECRET, etc.
```

### 2. Deploy

```bash
# Deployment completo con assets
make prod-deploy

# O paso a paso:
# Build de producci√≥n
BUILD_TARGET=production make prod-build

# Compilar assets para producci√≥n
make prod-build-assets

# Deploy
make prod

# Verificar
make health
```

### 3. Post-deployment

```bash
# Verificar servicios
docker-compose -f docker-compose.yml -f docker-compose.prod.yml ps

# Verificar logs
make prod-logs

# Test de conectividad
curl -k https://localhost/health
```

## üé® Gesti√≥n de Assets y Frontend

### Arquitectura de Assets

El proyecto utiliza **Vite** para la compilaci√≥n de assets con las siguientes caracter√≠sticas:

- **Desarrollo:** Hot reload y compilaci√≥n en tiempo real
- **Producci√≥n:** Compilaci√≥n optimizada con minificaci√≥n
- **Docker:** Contenedores temporales para producci√≥n, servicio permanente para desarrollo

### Configuraci√≥n de Vite

```javascript
// app/vite.config.js
import { defineConfig } from 'vite';
import laravel from 'laravel-vite-plugin';

export default defineConfig({
    plugins: [
        laravel({
            input: [
                'resources/css/app.css',
                'resources/js/app.js',
                "resources/css/filament/reportes/theme.css",
            ],
            refresh: true,
        }),
    ],
});
```

### Workflow de Assets

#### Desarrollo
```bash
# Iniciar modo desarrollo con hot reload
make assets-watch

# Compilar assets para desarrollo
make assets-build

# Verificar assets compilados
make assets-check
```

#### Producci√≥n
```bash
# Compilar assets optimizados
make prod-build-assets

# Verificar assets de producci√≥n
make assets-check
```

### Troubleshooting de Assets

```bash
# Si los assets no se cargan
make assets-clean          # Limpiar assets
make assets-install        # Reinstalar dependencias
make assets-build          # Recompilar

# Verificar que Vite est√© funcionando
make node-dev              # Iniciar Vite en modo desarrollo
make assets-check          # Verificar archivos compilados
```

## üìä Configuraci√≥n de Redis y Cache

Redis se utiliza para cache, sesiones y colas de trabajo:

### Configuraci√≥n b√°sica

```env
# .env.prod
REDIS_PASSWORD=password_segura
CACHE_DRIVER=redis
SESSION_DRIVER=redis
QUEUE_CONNECTION=redis
```

### Configuraci√≥n avanzada

```env
# Configuraci√≥n de memoria
REDIS_MAXMEMORY=2gb
REDIS_MAXMEMORY_POLICY=allkeys-lru

# Persistencia
REDIS_SAVE=900 1 300 10 60 10000
REDIS_APPENDONLY=yes
```

### Monitoreo de Redis

```bash
# Verificar estado de Redis
docker-compose exec redis redis-cli ping

# Ver logs
docker-compose logs redis

# Monitorear conexiones
docker-compose exec redis redis-cli monitor
```

## üêõ Troubleshooting

### Problema: "Application not found"

```bash
# Clonar aplicaci√≥n
make clone

# O manualmente
./scripts/clone-app.sh https://github.com/cristianfloyd/dgsuc-app.git
```

### Problema: "Connection refused" a Redis

```bash
# Verificar estado de Redis
docker-compose ps redis

# Reiniciar Redis
docker-compose restart redis

# Verificar conectividad
docker-compose exec app php artisan cache:clear
```

### Problema: "Memory exhausted" en SICOSS

```bash
# Editar docker-compose.prod.yml
# Aumentar l√≠mites de memoria para workers:
deploy:
  resources:
    limits:
      memory: 8G
```

### Problema: Permisos en storage y cache

```bash
# RECOMENDADO: Usar comandos make
make check-permissions        # Verificar estado actual
make fix-permissions          # Corregir autom√°ticamente
make check-writable          # Confirmar que funciona

# Alternativa: Script integrado del contenedor
make fix-permissions-script

# Desde el host (√∫ltimo recurso)
sudo chown -R 1000:1000 ./app/storage ./app/bootstrap/cache
chmod -R 775 ./app/storage ./app/bootstrap/cache

# Desde el contenedor manualmente
make shell
chown -R dgsuc_user:www-data storage bootstrap/cache
chmod -R 775 storage bootstrap/cache
```

> **‚ö†Ô∏è Nota**: El sistema usa `dgsuc_user:www-data` (UID 1000) para compatibilidad entre PHP-FPM y Nginx.

## üìä Monitoreo

### Prometheus + Grafana (Producci√≥n)

```bash
# Iniciar monitoreo
make monitor-start

# Acceder a Grafana
# http://localhost:3000
# Usuario: admin
# Password: (configurada en .env.prod)
```

### M√©tricas disponibles

- CPU y memoria por contenedor
- Requests por segundo (Nginx)
- Queries lentas (PostgreSQL)
- Cache hit rate (Redis)
- Queue jobs procesados
- Certificados SSL y expiraci√≥n

## üîí Seguridad

### Checklist de Producci√≥n

- [ ] Cambiar todas las contrase√±as por defecto
- [ ] Configurar SSL/TLS v√°lido
- [ ] Limitar acceso a puertos (firewall)
- [ ] Configurar backup autom√°tico
- [ ] Habilitar logs de auditor√≠a
- [ ] Configurar monitoreo
- [ ] Revisar permisos de archivos
- [ ] Actualizar im√°genes regularmente

### Hardening

```bash
# Escanear vulnerabilidades
docker scan dgsuc_app:latest

# Limitar recursos
docker update --memory="4g" --cpus="2" dgsuc_app

# Auditor√≠a con Trivy
docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
  aquasec/trivy image dgsuc_app:latest
```

## üìÅ Estructura de Directorios

```
dgsuc-docker/
‚îú‚îÄ‚îÄ docker/                    # Configuraciones Docker
‚îÇ   ‚îú‚îÄ‚îÄ app/                  # PHP-FPM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.dev
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php.ini
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ php-dev.ini
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh
‚îÇ   ‚îú‚îÄ‚îÄ nginx/                # Nginx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ sites/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ certs/
‚îÇ   ‚îú‚îÄ‚îÄ workers/              # Queue workers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ supervisord.conf
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ entrypoint.sh
‚îÇ   ‚îú‚îÄ‚îÄ postgres/             # PostgreSQL
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ init.sql
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ postgresql.conf
‚îÇ   ‚îú‚îÄ‚îÄ redis/                # Redis
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis.conf
‚îÇ   ‚îî‚îÄ‚îÄ monitoring/           # Prometheus + Grafana
‚îÇ       ‚îú‚îÄ‚îÄ prometheus/
‚îÇ       ‚îî‚îÄ‚îÄ grafana/
‚îú‚îÄ‚îÄ scripts/                   # Scripts de gesti√≥n
‚îÇ   ‚îú‚îÄ‚îÄ init.sh              # Inicializaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ clone-app.sh         # Clonar aplicaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ deploy.sh            # Deployment
‚îÇ   ‚îú‚îÄ‚îÄ backup.sh            # Backups
‚îÇ   ‚îî‚îÄ‚îÄ ssl-setup.sh         # Configurar SSL
‚îú‚îÄ‚îÄ app/                      # Aplicaci√≥n (ignorado en git)
‚îú‚îÄ‚îÄ docker-compose.yml        # Configuraci√≥n base
‚îú‚îÄ‚îÄ docker-compose.dev.yml    # Override desarrollo
‚îú‚îÄ‚îÄ docker-compose.prod.yml   # Override producci√≥n
‚îú‚îÄ‚îÄ .env.example             # Plantilla de variables
‚îú‚îÄ‚îÄ .gitignore
‚îú‚îÄ‚îÄ Makefile                 # Comandos simplificados
‚îî‚îÄ‚îÄ README.md                # Este archivo
```

## üîÑ Actualizaci√≥n de la Infraestructura

```bash
# Pull √∫ltimos cambios de infraestructura
git pull origin main

# Rebuild im√°genes
make prod-build

# Restart servicios
make prod-restart
```

## üîß Gesti√≥n de Credenciales de Base de Datos

### Sincronizaci√≥n Autom√°tica

El sistema ahora maneja autom√°ticamente la sincronizaci√≥n de credenciales entre Docker y Laravel:

- **PostgreSQL**: Utiliza variables del `.env` (`DB_USERNAME`, `DB_PASSWORD`, `DB_DATABASE`)
- **Laravel**: Usa el mismo `.env` copiado autom√°ticamente a `app/.env`
- **Usuarios creados autom√°ticamente**:
  - Usuario principal: `${DB_USERNAME}` con password `${DB_PASSWORD}`
  - Usuario readonly: `${DB_USERNAME}_readonly` con password `${DB_PASSWORD}_readonly`

### Verificar Sincronizaci√≥n

```bash
# Verificar credenciales en uso
grep "DB_" .env
grep "DB_" ./app/.env

# Si est√°n desincronizadas, el script init.sh lo detectar√° autom√°ticamente
make init
```

### Cambiar Credenciales

```bash
# 1. Editar .env principal
nano .env

# 2. Sincronizar con Laravel
cp .env ./app/.env

# 3. Recrear base de datos
make dev-clean
make dev
```

## üìù Variables de Entorno Importantes

| Variable | Descripci√≥n | Ejemplo |
|----------|-------------|---------|
| `APP_ENV` | Entorno de aplicaci√≥n | production |
| `APP_URL` | URL de la aplicaci√≥n | https://dgsuc.uba.ar |
| `DB_PASSWORD` | Contrase√±a PostgreSQL | SecurePass123! |
| `REDIS_PASSWORD` | Contrase√±a Redis | RedisPass456! |
| `MICROSOFT_CLIENT_ID` | Azure AD Client ID | xxx-xxx-xxx |
| `CERTBOT_EMAIL` | Email para certificados SSL | admin@uba.ar |
| `CERTBOT_DOMAIN` | Dominio principal | dgsuc.uba.ar |
| `WORKER_MEMORY` | Memoria para workers | 4096 |
| `GRAFANA_PASSWORD` | Contrase√±a Grafana | GrafanaPass789! |

## ü§ù Contribuir

1. Fork del repositorio
2. Crear rama feature (`git checkout -b feature/AmazingFeature`)
3. Commit cambios (`git commit -m 'Add AmazingFeature'`)
4. Push a la rama (`git push origin feature/AmazingFeature`)
5. Abrir Pull Request

## üìö Documentaci√≥n Adicional

- [Gu√≠a de Deployment Detallada](./docs/deployment.md)
- [Configuraci√≥n Avanzada](./docs/advanced.md)
- [Troubleshooting Completo](./docs/troubleshooting.md)
- [Arquitectura del Sistema](./docs/architecture.md)

## üìû Soporte

- **Email**: carenas@uba.ar
- **Issues**: https://github.com/cristianfloyd/dgsuc-docker/issues
- **Wiki**: https://github.com/cristianfloyd/dgsuc-docker/wiki

## üìÑ Licencia

Propiedad de la Universidad de Buenos Aires - Todos los derechos reservados.

---

**Versi√≥n**: 2.0.0  
**√öltima actualizaci√≥n**: Diciembre 2024  
**Mantenido por**: Equipo DGSUC - UBA